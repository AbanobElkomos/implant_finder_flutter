import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../../domain/models/vendor.dart';
import '../../data/repositories/vendor_repository_impl.dart';

class VendorFormController extends GetxController {
  final VendorRepositoryImpl _repository;
  final SupabaseClient _supabase;

  VendorFormController(this._repository, this._supabase);

  // Form Key
  final GlobalKey<FormState> formKey = GlobalKey<FormState>();

  // Controllers
  final TextEditingController nameController = TextEditingController();
  final TextEditingController countryController = TextEditingController();
  final TextEditingController emailController = TextEditingController();
  final TextEditingController websiteController = TextEditingController();
  final TextEditingController addressController = TextEditingController();
  final TextEditingController logoController = TextEditingController();
  final List<TextEditingController> phoneControllers = [TextEditingController()];

  // State
  final RxBool isLoading = false.obs;
  final RxBool isEditing = false.obs;
  final Rx<String?> vendorId = Rx<String?>(null);

  @override
  void onClose() {
    nameController.dispose();
    countryController.dispose();
    emailController.dispose();
    websiteController.dispose();
    addressController.dispose();
    logoController.dispose();
    for (var controller in phoneControllers) {
      controller.dispose();
    }
    super.onClose();
  }

  // Initialize form with existing vendor data
  void initializeForm(Vendor vendor) {
    isEditing.value = true;
    vendorId.value = vendor.id;

    nameController.text = vendor.name;
    countryController.text = vendor.organ ?? '';
    emailController.text = vendor.email ?? '';
    websiteController.text = vendor.website ?? '';
    addressController.text = vendor.address ?? '';
    logoController.text = vendor.logo ?? '';

    // Clear existing phone controllers
    for (var controller in phoneControllers) {
      controller.dispose();
    }
    phoneControllers.clear();

    // Add phone controllers for each phone
    if (vendor.phone.isNotEmpty) {
      for (var phone in vendor.phone) {
        phoneControllers.add(TextEditingController(text: phone));
      }
    } else {
      phoneControllers.add(TextEditingController());
    }
  }

  // Add phone field
  void addPhoneField() {
    phoneControllers.add(TextEditingController());
    update();
  }

  // Remove phone field
  void removePhoneField(int index) {
    if (phoneControllers.length > 1) {
      phoneControllers[index].dispose();
      phoneControllers.removeAt(index);
      update();
    }
  }

  // Submit form
  Future<void> submitForm() async {
    if (!formKey.currentState!.validate()) {
      return;
    }

    isLoading.value = true;

    try {
      // Collect phone numbers
      final phoneNumbers = phoneControllers
          .map((controller) => controller.text.trim())
          .where((phone) => phone.isNotEmpty)
          .toList();

      // Create vendor object
      final vendor = Vendor(
        id: vendorId.value ?? '', // Will be generated by Supabase for new vendors
        createdAt: DateTime.now(),
        name: nameController.text.trim(),
        organ: countryController.text.trim(),
        email: emailController.text.trim().isNotEmpty ? emailController.text.trim() : null,
        website: websiteController.text.trim().isNotEmpty ? websiteController.text.trim() : null,
        address: addressController.text.trim().isNotEmpty ? addressController.text.trim() : null,
        logo: logoController.text.trim().isNotEmpty ? logoController.text.trim() : null,
        phone: phoneNumbers,
      );

      if (isEditing.value && vendorId.value != null) {
        // Update existing vendor
        await _updateVendor(vendor);
      } else {
        // Create new vendor
        await _createVendor(vendor);
      }
    } catch (e) {
      Get.snackbar(
        'Error',
        'Failed to save vendor: $e',
        backgroundColor: Colors.red,
        colorText: Colors.white,
      );
    } finally {
      isLoading.value = false;
    }
  }

  Future<void> _createVendor(Vendor vendor) async {
    try {
      // Prepare data for Supabase
      final vendorData = vendor.toJson();
      // Remove id if empty (will be generated by Supabase)
      if (vendorData['id'] == '') {
        vendorData.remove('id');
      }

      final response = await _supabase
          .from('vendors')
          .insert(vendorData)
          .select()
          .single();

      Get.snackbar(
        'Success',
        'Vendor added successfully',
        backgroundColor: Colors.green,
        colorText: Colors.white,
      );

      // Navigate back to vendor list
      Get.until((route) => route.settings.name == '/vendors');
    } catch (e) {
      throw Exception('Failed to create vendor: $e');
    }
  }

  Future<void> _updateVendor(Vendor vendor) async {
    try {
      final vendorData = vendor.toJson();

      await _supabase
          .from('vendors')
          .update(vendorData)
          .eq('id', vendorId.value!);

      Get.snackbar(
        'Success',
        'Vendor updated successfully',
        backgroundColor: Colors.green,
        colorText: Colors.white,
      );

      // Navigate back to vendor detail or list
      Get.until((route) => route.settings.name?.startsWith('/vendor/') ?? false);
    } catch (e) {
      throw Exception('Failed to update vendor: $e');
    }
  }

  Future<void> deleteVendor() async {
    if (vendorId.value == null) return;

    isLoading.value = true;

    try {
      await _supabase
          .from('vendors')
          .delete()
          .eq('id', vendorId.value!);

      Get.snackbar(
        'Success',
        'Vendor deleted successfully',
        backgroundColor: Colors.green,
        colorText: Colors.white,
      );

      // Navigate back to vendor list
      Get.offNamedUntil('/vendors', (route) => false);
    } catch (e) {
      Get.snackbar(
        'Error',
        'Failed to delete vendor: $e',
        backgroundColor: Colors.red,
        colorText: Colors.white,
      );
    } finally {
      isLoading.value = false;
    }
  }


}